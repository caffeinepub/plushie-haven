{
  "kind": "build_request",
  "title": "Add user profiles (public directory + individual profile pages) with opt-in listing and authenticated editing",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-31",
      "text": "Extend the backend user profile model to support a full profile with the following fields: avatar image (bytes + content type), display name, bio, links, plushie collection images (multiple images, each bytes + content type), and a public directory opt-in flag. Keep fields optional where appropriate to support future optional fields without breaking callers.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "add profiles",
          "both, all, login in",
          "yes,optin out, 1",
          "yes all",
          "yes"
        ]
      },
      "acceptanceCriteria": [
        "The backend exposes a UserProfile type that includes: avatar (optional image), displayName (optional text), bio (optional text), links (list of link entries, can be empty), plushieCollectionImages (list, can be empty), and directoryOptIn (boolean).",
        "Profile fields allow empty/absent values without trapping (except where explicitly required by later requirements)."
      ]
    },
    {
      "id": "REQ-32",
      "text": "Update backend authorization rules for profiles to match: profiles are publicly viewable when the profile owner has opted into the public directory; otherwise, viewing a profile is restricted to the owner and admins. Editing a profile (saving) requires the caller to be authenticated.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Profiles are publicly viewable; editing requires login. Users are hidden from the public directory by default unless they opt in (and can opt out)."
        ]
      },
      "acceptanceCriteria": [
        "An anonymous caller can view a user’s profile only if that user’s directoryOptIn is true.",
        "A logged-in caller can view their own profile regardless of directoryOptIn.",
        "An admin can view any profile regardless of directoryOptIn.",
        "Any attempt to save/update a profile by an anonymous caller fails with an authorization error."
      ]
    },
    {
      "id": "REQ-33",
      "text": "Add backend canister methods to support a public profile directory and profile CRUD flows needed by the UI: (1) get the caller’s profile (for editing), (2) get a profile by principal with the access rules described, (3) save/update the caller’s profile, and (4) list directory profiles (only those opted in).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "both",
          "optin out",
          "Profiles are publicly viewable; editing requires login. Users are hidden from the public directory by default unless they opt in (and can opt out)."
        ]
      },
      "acceptanceCriteria": [
        "There is a query method that returns the directory listing containing only opted-in profiles.",
        "There is a query method to fetch a single profile by principal that enforces the public-vs-private viewing rules.",
        "There is a shared method to save/update the caller’s profile that enforces authenticated-only editing.",
        "The directory listing defaults to empty for users who have never created a profile or who are not opted in."
      ]
    },
    {
      "id": "REQ-34",
      "text": "Update the generated/typed frontend backend bindings and React Query hooks to support: fetching the public profile directory, fetching a profile by principal, fetching the signed-in user’s own profile for editing, and saving the signed-in user’s profile. Ensure queries invalidate/refresh appropriately after a successful save.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "add profiles",
          "both, all, login in",
          "yes all"
        ]
      },
      "acceptanceCriteria": [
        "React Query hooks exist for: list directory profiles, get profile by principal, get caller profile, and save caller profile.",
        "After saving a profile, the relevant cached queries (caller profile and that principal’s profile and directory listing when applicable) are invalidated/refetched so the UI updates without a manual reload.",
        "Errors from profile calls are surfaced as readable English messages (reusing the existing error normalization pattern where applicable)."
      ]
    },
    {
      "id": "REQ-35",
      "text": "Add a new Profiles section to the frontend including: (1) a public profile directory page that shows only opted-in profiles, and (2) an individual profile page that can be visited publicly when opted-in. Include clear English empty states when no profiles are listed or when a profile is not available to the viewer.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "both",
          "Profiles are publicly viewable",
          "Users are hidden from the public directory by default unless they opt in"
        ]
      },
      "acceptanceCriteria": [
        "A Profiles directory route exists and renders a list/grid of opted-in profiles with at least avatar (if present), display name (fallback to a safe label if absent), and a link to the profile detail page.",
        "A Profile detail route exists that renders the selected user’s profile data (avatar, display name, bio, links, plushie collection images).",
        "If the directory is empty, the page shows an English empty state (e.g., “No profiles yet” with a short explanation).",
        "If a profile is not viewable due to opt-out/private status, the UI shows an English message indicating it is not available."
      ]
    },
    {
      "id": "REQ-36",
      "text": "Implement authenticated profile editing: on the individual profile page, if the viewer is the profile owner (same Internet Identity principal), show an Edit Profile UI that allows updating all profile fields (avatar, display name, bio, links, plushie collection images) and toggling directory opt-in/out. Editing must require login; unauthenticated users must not see editing controls.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "editing requires login",
          "yes all",
          "optin out"
        ]
      },
      "acceptanceCriteria": [
        "When not signed in, no profile editing UI is shown.",
        "When signed in and viewing your own profile, an Edit Profile form is available with Save/Cancel behavior and appropriate loading/disabled states while saving.",
        "The form supports toggling directory opt-in/out and saving persists the change and updates the directory behavior accordingly.",
        "Avatar upload supports common web image types (PNG/JPEG/WebP) and shows a preview before saving.",
        "Plushie collection images support adding multiple images, showing previews, and removing selected images before saving."
      ]
    },
    {
      "id": "REQ-37",
      "text": "Add navigation access to the new Profiles section in the existing site navigation without changing unrelated layout structure or modifying immutable frontend paths.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "add profiles"
        ]
      },
      "acceptanceCriteria": [
        "The primary navigation includes a “Profiles” link that routes to the Profiles directory page.",
        "Navigation styling remains consistent with the existing cozy pastel theme and component patterns.",
        "No changes are made to files under the listed immutable frontend paths."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in backend/main.mo; do not introduce additional backend services.",
    "Do not edit any frontend files under frontend/immutablePaths (including frontend/src/hooks/useInternetIdentity.ts(x), frontend/src/hooks/useActor.ts, frontend/src/main.tsx, and frontend/src/components/ui). Compose existing UI components instead.",
    "Use English for all user-facing text.",
    "Profiles must be publicly viewable only when the user has opted in; editing must require login; default directory visibility is opt-out (hidden)."
  ],
  "nonGoals": [
    "Do not add third-party authentication providers beyond Internet Identity.",
    "Do not add real-time presence/chat or WebSocket features.",
    "Do not implement external database storage or integrations.",
    "Do not implement advanced moderation/reporting systems for profiles unless explicitly requested later."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [
      "Add user Profiles: individual user profile pages plus a public profile directory; include avatar, display name, bio, links, and plushie collection images; profiles publicly viewable when opted-in; editing requires login; users hidden from directory by default unless they opt in/out."
    ],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}